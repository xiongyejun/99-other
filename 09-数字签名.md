[[http://blog.csdn.net/cwqbuptcwqbupt/article/details/7590855](http://blog.csdn.net/cwqbuptcwqbupt/article/details/7590855)](http://www.cnblogs.com/1-2-3/archive/2007/09/17/colloquialism-digital-certificate-part1.html)

# 白话数字签名(1)——基本原理 #

由于数字签名基于非对称加密技术，所以我们需要先啰嗦一下**对称加密**和**非对称加密**技术。


## 对称加密 ##


何谓加密？加密是一种“把数据搞乱掉”的技术。加密技术涉及到4种东东：

**明文：**可以被人或程序识别的数据。例如一个文本文件、一段歌词、一个Word文档、一首MP3、一个图片文件、一段视频等等。

**加密算法：**将数据搞乱掉的方法。

**密钥（密码）：**一个你在进行加密操作时给出的字符串，让加密算法不但把明文“搞乱掉”，而且要乱得“与众不同”。这样即使别人搞到了解密算法，如果没有当初加密时所使用的密码，一样无法进行解密操作。

**密文：**明文被加密算法和密钥加密后的结果。它看上去就是一堆乱码，没有人或程序能知道它到底表示什么信息。


作为加密的一个实例，我将使用由我杜撰的“景氏替换加密算法”演示一下加密过程。

- 明文：good good study, day day up.
- 密钥：google
- 景氏替换加密算法：将明文中的所有的字母“d”替换成密钥。
- 密文：将“good good study, day day up.”中的所有字母“d”替换成“google”，就得到密文“googoogle googoogle stugoogley,  googleay googleay up.”。这个密文乱得还可以吧？一般人看了肯定不知道它是什么意思。


那么什么是解密呢？解密就是把密文再变回明文的过程。

例如“景氏替换解密算法”就是：将密文中所有与密钥相同的字符串替换成“d”。

- 密文：googoogle googoogle stugoogley,  googleay googleay up.
- 密钥：google
- 景氏替换解密算法：将密文中所有与密钥相同的字符串替换成“d”。
- 明文：将“googoogle googoogle stugoogley,  googleay googleay up.”中的所有“google”替换成“d”，就得到了明文“good good study, day day up.”。


您肯定已经注意到了，我们在进行加密和解密时使用的密钥必须是相同的，例如在上例中，加密和解密都必须使用相同的密钥“google”。所以像“景氏替换加密算法”这种就被称为对称加密算法。目前最为流行的对称加密算法是DES和AES，此外，对称加密算法还有IDEA、FEAL、LOKI、Lucifer、RC2、RC4、RC5、Blow fish、GOST、CAST、SAFER、SEAL等。WinRAR的文件加密功能就是使用的AES加密算法。

- 如果是已经保存在**自己硬盘**上的文件，使用对称加密技术进行加密是没有问题的；如果是两个人通过网络传输文件，使用对称加密就很危险——因为在传送密文的同时，还**必须传送解密密钥**。

## 非对称加密 ##


非对称加密算法是一类与众不同的加密算法，它的密钥不是1个，而是2个（一对），我们先姑且称它们为密钥K1和密钥K2。非对称加密算法的特点是，如果用密钥K1进行加密，则有且仅有密钥K2能进行解密；反之，如果使用密钥K2进行了加密，则有且仅有密钥K1能进行解密。注意“有且仅有”的意思——如果用密钥K1进行了加密，是不能用密钥K1进行解密的；同样，如果用密钥K2进行了加密，也无法用密钥K2进行解密。这是一个非常重要的特性，至于如何在实际中运用这个特性，请看下文。


我想给Clark传送一个AV小电影，又怕被他的老婆发现......


话说俺得了一个很不错的AV小电影，想通过网络传送给Clark，可是又怕被他的老婆发现（因为Clark的老婆是一个超级黑客，她可以使用sniffer技术截获任何通过网线传送给Clark的数据。别跟我说用VPN，它超出了本文讨论的范围），怎么办呢？对了，我们需要一个“将数据搞乱掉”的技术——加密技术。

我先使用WinRAR对小电影进行压缩，然后加上密码“TswcbyyqjsjhfL”（还记得么？WinRAR的文件加密功能使用的是叫作AES的对称加密算法）。接着，将这个加密后的文件通过QQ传送给Clark。然后，兴冲冲地拨打Clark的手机：

“喂？Clark么？好久不见，呵呵......我给你发了个好东东呦，在QQ上，收到没？......密码是TswcbyyqjsjhfL，对，就是天生我才必有用，千金散尽还复来的首字母，第一个和最后一个字母要大写呦......” 

可是，Clark，我是真的不知道你的老婆大人刚刚就在你的身边呀！而且你也知道，我打电话从来都是喜欢很大声的......呜呜呜......

在Clark跪了一夜的搓衣板之后，我们都明白：如果是已经保存在自己硬盘上的文件，使用对称加密技术进行加密是没有问题的；如果是两个人通过网络传输文件，使用对称加密就很危险——因为在传送密文的同时，还必须传送解密密钥。我们需要一个与众不同的加密算法，一个不需要传递解密密钥的加密算法。非对称加密正好可以满足我们的需要。基本思路是这样的：

- 首先，生成一对满足非对称加密要求的密钥对（密钥K1和密钥K2）。
- 然后，将密钥K1公布在网上，任何人都可以下载它，我们称这个已经公开的密钥K1为公钥；密钥K2自己留着，不让任何人知道，我们称这个只有自己知道的密钥K2为私钥。

当我想给Clark传送小电影时，我可以用Clark的公钥对小电影进行加密，之后这个密文就连我也无法解密了。这个世界上只有一个人能将密文解密，这个人就是拥有私钥的Clark。


后来......


后来，Clark痛定思痛，决定申请一个**数字证书**。

**数字证书中包括：所有者的公钥 所有者的名字 公钥的失效期 发放机构的名称（发放数字证书的 CA）数字证书的序列号 发放机构的数字签名等，他的作用就是向其他人证明他是可信的是真实的；数字签名都是和很多加密算法一起使用的。**

流程是这样的：

首先，登录当地的数字证书认证中心网站，填表->出示个人有效证件原件和复印件->缴费->等待数字证书认证中心制作数字证书->领取数字证书。

如果您的公司需要申请大量的数字证书，还可以与认证中心的销售人员商量，先领取免费的试用版的数字证书供技术人员试用。

后来的后来，我又得到了一本电子版的不良漫画，当然，我又想到了Clark。我先在数字证书认证中心下载了Clark的公钥证书(就是一个含有公钥信息的文件)，使用非对称加密算法对不良漫画进行加密，再将密文通过QQ传送给Clark。然后，我兴冲冲地拨打Clark的手机：

“喂？Clark么？好久不见，呵呵......我给你发了个好东东呦，在QQ上，收到没？......已经用你的公钥加密了。用你的私钥解密就行了^_^”

Clark兴冲冲地插入他的私钥（忘了说了，**私钥并不是一个文件，而是一个USB设备**，外形就跟U盘一样，至于为什么要这样，下一篇再说），解密，然后开始看漫画，完全没察觉他的老婆大人就在身后......


Clark，俺这个月手头有点紧......


唉，这个月买了太多的书，到月底揭不开锅了。正巧在QQ上遇到了Clark：

- 1-2-3：“Clark，我需要200两纹银，能否借给我？”
- Clark：“没问题。我这就给你转账。请给我一张借条。”
- 1-2-3：“太谢谢了，我这就用Word写一个借条给你。”

然后，我新建一个Word文档，写好借条，存盘。然后，然后怎么办呢？我不能直接把借条发送给Clark，原因有：

1. 我无法保证Clark不会在收到借条后将“纹银200两”改为“纹银2000两”。
2. 如果我赖账，Clark无法证明这个借条就是我写的。
3. 普通的Word文档不能作为打官司的证据。
   
好在我早就申请了数字证书。

- 我先用我的私钥对借条进行加密，
- 然后将加密后的密文用QQ发送给Clark。
- Clark收到了借条的密文后，在数字证书认证中心的网站上下载我的公钥，然后使用我的公钥将密文解密，

发现确实写的是“借纹银200两”，Clark就可以把银子放心的借给我了，我也不会担心Clark会篡改我的借条，原因是：

1. 由于我发给Clark的是密文，Clark无法进行修改。Clark倒是可以修改解密后的借条，但是Clark没有我的私钥，没法模仿我对借条进行加密。这就叫**防篡改**。
2. 由于用我的私钥进行加密的借条，有且只有我的公钥可以解密。反过来讲，能用我的公钥解密的借条，一定是使用我的私钥加密的，而只有我才拥有我的私钥，这样Clark就可以证明这个借条就是我写的。这就叫**防抵赖**。
3. 如果我一直赖着不还钱，Clark把我告上了法庭，这个用我的私钥加密过的Word文档就可以当作   
程堂证供。因为我国已经出台了《中华人民共和国电子签名法》，使数字签名具有了法律效力。

您一定已经注意到了，这个使用我的私钥进行了加密的借条，具有了防篡改、防抵赖的特性，并且可以作为程堂证供，就跟我对这个借条进行了“签名”的效果是一样的。对了，“使用我的私钥对借条进行加密”的**过程**就叫做**数字签名**。（由于数字签名算法的速度比较慢，所以在实际对文件签名的过程比上面提到的方法稍稍复杂一些，这个在下一篇再讲）。


我是1-2-3，我真的是1-2-3，我是真的1-2-3


正如您已经知道的，Clark的老婆是一名超级黑客——就是传说中能用计算机作任何事的人。这不，不久前她就轻松入侵了QQ数据库，下载了Clark的所有好友的ID和密码以及聊天记录。然后，时不时地伪装成Clark的好友跟Clark聊天，搞得Clark最近总是神经兮兮、疑神疑鬼的。这不，昨天我在QQ上遇到了Clark：

- 1-2-3：“Clark，最近还好吧？我又搞到一个好东东呦，要不要？”
- Clark：“48475bbt556”

Clark并不是疯掉了，那个“48475bbt556”也不是我跟Clark之间的什么通关暗语。这个“48475bbt556”就是Clark在键盘上胡乱敲上去的，不过，我却知道Clark是什么意思。我立刻把“48475bbt556”粘贴到Word里，然后用我的私钥对这个Word文档加密，再将这个Word文档发送给Clark。Clark在那边用我的公钥将Word文档解密，打开，发现里面写的就是“48475bbt556”，就知道QQ这边的确就是真正的我本人了。因为拥有我的私钥的人在这个世界上就只有我一人而已，Clark的老婆大人就是再神通广大也模仿不了，这就是数字签名的验证功能。

顺便提一句，不但人可以申请数字证书，设备（例如Web服务器）也可以申请数字证书（叫作设备证书）。利用数字签名的验证功能，就可以验证服务器的身份了，这可是防钓鱼的终极解决方案呦。

# 白话数字签名(2)——软件&设备 #

## 然而它太慢了 ##

非对称加密算法有一个重大缺点——加密速度慢，或者说得更拽一些，编码率比较低。例如在上一篇里我给Clark传的那个1GB的小电影，进行非对称加密足足用了66小时。那个借条小一些吧，也用了将近2分钟。所以在实际使用非对称加密的时候，往往不直接对文件进行加密，而是使用**摘要算法**与非对称算法相结合（适用于数字签名）或对称加密和非对称加密相结合（适用于加密传输文件）的办法来解决或者说绕过非对称加密算法速度慢的问题。

**摘要算法**，又叫作Hash算法或散列算法，是一种将任意长度的输入浓缩成固定长度的字符串的算法，注意是“**浓缩**”而不是“**压缩**”，因为这个过程是**不可逆**的。它的特点是：

1. 不同内容的文件生成的散列值一定不同；(转者注：这句话有问题。不同内容生成的散列值可能会相同，否则就不存在“冲突”问题了) 相同内容的文件生成的散列值一定相同。由于这个特性，摘要算法又被形象地称为文件的“数字指纹”。
2. 不管文件多小（例如只有一个字节）或多大（例如几百GB），生成的散列值的长度都相同，而且一般都只有几十个字符。

这个神奇的算法被广泛应用于比较两个文件的内容是否相同——散列值相同，文件内容必然相同；散列值不同，文件内容必然不同。如果您用过BT或eMule，应该对散列值比较熟悉了，右图分别是BT和eMule的文件详细信息的截图。

![](http://images.cnblogs.com/cnblogs_com/1-2-3/colloquialism-digital-certificate/2-1.png)

![](http://images.cnblogs.com/cnblogs_com/1-2-3/colloquialism-digital-certificate/2-2.png)

细心的朋友可能已经注意到了，BT和eMule的散列值的长度不一样，这是因为它们所使用的摘要算法不同，目前比较流行的摘要算法主要有MD5和SHA-1，您可以在.Net的System.Security.Cryptography命名空间找到它们的身影。

另，由于本篇是只重理解和应用的白话文，所以上面对摘要算法的讨论并不十分全面严谨，喜欢看文言文的朋友可以看这篇《Hash 算法及其应用》。还有就是MD5和SHA-1算法已经从理论上被山东大学王小云教授及其研究小组破解（向中国的科学家致敬！），不过并不是这两个算法从此就不能用了。

## 实际对文件作数字签名的方法 ##

由于非对称加密的速度实在太慢了，所以在实际对文件作数字签名的时候，例如对上一篇中我用Word写给Clark的借条进行签名，总是先生成这个借条的散列值，然后用我的私钥对这个散列值进行非对称加密，然后把加密后的散列值（我们就叫它“散列值密文”吧）和借条一同发送到Clark那里。Clark在收到借条和散列值密文后，用从网上下载的我的公钥将散列值解密，然后Clark自己再生成一次借条的散列值，比对这两个散列值是否相同，如果相同，就叫作验证签名成功。由于散列值只有几十个字节，所以签名的速度还可以忍受。看下图会更直观一些。
![](http://images.cnblogs.com/cnblogs_com/1-2-3/colloquialism-digital-certificate/2-3.png)

 ## 又太麻烦了 ##

我们费了好大的劲终于解决了数字签名速度慢的问题。但是上面那个复杂的签名过程用户能接受吗？当然不能！所以我们必须要开发出一个数字签名的程序来简化签名过程，最好让数字签名看起来就跟传统的盖章差不多。这样的程序已经有了，叫作**电子签章程序**。 它是一个桌面程序，一般以Word或Excel插件的形式存在。下面就演示一下用电子签章程序对我的借条进行签名的过程。

1. 安装了电子签章程序后，Word和Excel中就会多出一个签名用的工具条。

![](http://images.cnblogs.com/cnblogs_com/1-2-3/colloquialism-digital-certificate/2-4.png)

2. 写好借条，存盘。然后用鼠标点击“添加电子签章”按钮。然后在需要显示印章图片的位置上再按一次鼠标左键。
![](http://images.cnblogs.com/cnblogs_com/1-2-3/colloquialism-digital-certificate/2-5.png)

3. 电子签章程序会弹出一个对话框，注意在这步一定要勾选“签章后锁定文件”复选框，至于为什么要这样，稍后再讲。然后点击确定按钮。

![](http://images.cnblogs.com/cnblogs_com/1-2-3/colloquialism-digital-certificate/2-6.png)

4. 在上一步按确定按钮后，电子签章程序还会提示要求我输入存放私钥的USB-Key的使用密码，然后Word中就会出现一个印章了。这个印章图片是我提供给数字证书中心，在制作USB-Key的时候就烧录在USB-Key之中的。

![](http://images.cnblogs.com/cnblogs_com/1-2-3/colloquialism-digital-certificate/2-7.png)

5. 之后我把借条发送给Clark。Clark想验证签名的话只要按“验证所有印章”就可以了。电子签章会弹出如左图所示的对话框。

![](http://images.cnblogs.com/cnblogs_com/1-2-3/colloquialism-digital-certificate/2-8.png)

是不是即直观又简单？那么诸如“散列值”、“公钥证书”这些东东都跑到哪里去了呢？它们都被电子签章程序插入到Word文档中的某个特定的地方了，如果你熟悉Word文档的结构，是不难找到它们的。

## 电子签章程序的Bug ##

电子签章程序本来可以支持两种用法：

1. 在上面的第3步不勾选“签章后锁定文件”复选框，这样在进行了数字签名之后，仍然可以更改Word文档的内容。当然如果在进行了数字签名之后又更改了Word文档的内容，验证签名操作就会失败。这时需要再次进行签名操作。
2. 在上面的第3步勾选“签章后锁定文件”复选框，这样在进行了签名操作后，Word文档的内容就再也无法更改了。

但是，电子签章程序有一个大Bug——在进行了签名操作后，如果只是更改了文字的颜色，验证签名操作仍然会成功。这就意味着，如果我在Word中写到“向公司借款2000元”，然后把“2000”的最后一个0的颜色改为白色，在领导看来就是“向公司借款200 元”。领导欣然签章，然后我再把那最后一个0的颜色改为黑色，就又变成了“向公司借款2000元”，而且验证签名居然会成功。这也是为什么我在上面的第3步要强调一定要勾选“签章后锁定文件”复选框了。我猜测造成这个Bug的原因很可能是因为电子签章程序仅仅对文档中的纯文本生成散列值，而不是对文本+全部格式信息一同生成散列值。大家在购买电子签章程序前一定要作这方面的测试。

## 数字信封 ##

我们可以通过使用信息摘要技术解决数字签名的速度问题，那么数字加密的速度问题怎么解决呢？相信除了我和Clark以外，很少有人愿意为传送一个小电影而等待66个小时。其实这个问题也简单，我们可以用对称加密与非对称加密相结合的方式来解决这个问题。对称加密速度快，但是必须在传送密文的同时传送解密密钥；非对称加密速度慢，但是不需要传送解密密钥。把两个技术一起使用，各取优点，就OK了。方法是，先把小电影用对称加密算法加密，然后把解密密钥用非对称加密算法加密。再将小电影的密文与解密密钥的密文同时传送给Clark。Clark收到这两样东西后，先用自己的私钥将解密密钥的密文解密，得到解密密钥，再用解密密钥将小电影的密文解密，就得到了小电影的明文。Clark收到的这两样东西——小电影的**密文和解密密钥的密文**——加在一起就叫作数字信封。看下图会更直观一些。

![](http://images.cnblogs.com/cnblogs_com/1-2-3/colloquialism-digital-certificate/2-9.png)

**数字证书**

非对称加密的公钥和私钥的长度都很长，一般都在1024位以上。这么长且无规律的密码，用户是记不住的，所以只能保存在文件中啦。保存了**公钥的文件**就叫作**数字证书**。且慢，这个定义是十分错误的！为什么呢？想一想第1篇里的那个我给Clark发送小电影的例子。例子中我在网上下载了Clark的公钥（也就是数字证书），然后用它对小电影进行非对称加密，然后心想只有拥有Clark的私钥的Clark才能解密——Clark的老婆一定没辙啦。没想到螳螂捕蝉，黄雀在后，我下载Clark的公钥的那个网站是Clark的老婆制作的钓鱼网站！里面的公钥证书统统都是Clark的老婆的公钥！！结果呢，我的小电影用Clark的私钥解不开，反倒是只有用Clark老婆的私钥才能解开，用Clark的话来说，就是“无语了......”。

所以聪明的你一定想到了，数字证书之所以可以称之为“证书”，就一定要有“**防伪**”功能。方法是，数字证书里不但要包含Clark的**公钥**，还要包含Clark的**自然信息（姓名、单位等）**，并且最重要的，要有证书**颁发部门**对这些信息的**数字签名**（每个证书颁发部门也都有自己的数字证书——称之为根证书——和与之配对使用的私钥）。这样我就可以验证数字证书的真伪了。所以，让我们重新定义**数字证书，数字证书是由一个权威机构发行的，至少包含一个公开密钥、证书持有人（或单位）的名称以及证书授权中心对这些信息的数字签名的文件。**一般情况下证书中还包括密钥的有效时间，发证机关(证书授权中心)的名称，该证书的序列号等信息，证书的格式遵循ITUT X.509国际标准。

![](http://images.cnblogs.com/cnblogs_com/1-2-3/colloquialism-digital-certificate/2-14.png)

您可以使用IE的菜单“工具 | Internet 选项... -> 内容 -> 证书... -> 受信任的根证书颁发机构”来查看IE中已经安装的根证书。点击“导入...”按钮可以导入新的根证书。

**复制破解的解决方案——USB Key**

我们已经知道， 非对称加密的密钥很长，一般都在1024位以上，所以只能保存在文件里。好，我把私钥文件保存在了硬盘上，却难保哪天这个文件不会被某个坏蛋拷贝走。然后，在这个“没有人知道你是一条狗”的网络世界里，他就变成了我——他可以冒充我写借条甚至向银行贷款；他可以冒充我跟别的公司签署上亿美元的合同；他甚至可以冒充我签署卖身契，300块钱就把我卖了——而我却懵然不知。直到有一天，我突然发现自己突然增加了几百万外债、公司把我Fire了、一个9岁的小女孩拿着卖身契等在我家门口声称我已经是她的奴隶......

所以千万不能把私钥保存在硬盘上。那么保存在U盘上，并且把U盘放在内裤的口袋里怎么样呢？好像好了一些，但是你在签名的时候还是得把U盘插在电脑上吧？可知道你的电脑中有多少木马程序正在用For循环扫描你的USB端口，就等着拷贝你的私钥？

我们需要的是无论如何也不可能被别人复制的私钥保存方案，USB Key应运而生。USB Key是一种USB设备，外形就跟U盘一样，只不过无法用它来存取文件。证书发行单位会使用特殊的设备将你的数字证书、私钥和电子签章程序所要使用的印章图片烧录到USB Key中。你无法使用资源管理器或木马程序取得USB Key中的私钥，当需要用私钥进行签名时，直接通过USB Key的驱动程序提供的API将明文传输到USB Key中，由USB Key中的加密芯片对明文进行加密，加密结果会以API函数的返回值的形式返回，这样就可以有效解决私钥被坏蛋复制的问题了。还有就是USB Key本身还有一个简短的使用密码，每次加密前使用者必须输入正确的使用密码方能使用，这样即使USB Key不慎丢失，也不用担心了。

### USB Key的缺点 ###


USB Key有一个不大不小的缺点——速度有点慢。例如我手里正在试用的这款USB Key，连续签10个像“1234”这样的数据需要约13秒。这意味着如果你的信息系统只提供一次一条数据的签名方式，那么这1秒钟的延迟用户根本感觉不到；但是也有很多领导喜欢一次批量签名100条数据，那么就需要用2分钟来完成这项工作。经我本人测试以及向数字证书认证单位技术人员确认，速度的瓶颈主要在于数据往返于信息系统程序与USB Key之间所消耗的时间较长。所以很难通过优化信息系统程序或使用具有更快芯片的USB Key的方法来提高速度。
![](http://images.cnblogs.com/cnblogs_com/1-2-3/colloquialism-digital-certificate/2-13.png)

